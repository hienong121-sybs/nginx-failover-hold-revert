version: "3.8"

services:
  nginx:
    image: nginx:1.25-alpine
    container_name: edge-nginx
    ports:
      - "8080:8080"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - app
      - hold
    restart: unless-stopped

  app:
    build: ./app
    container_name: demo-app
    environment:
      - PORT=3000
    restart: unless-stopped

  hold:
    build: ./hold
    container_name: hold-server
    environment:
      - PORT=4000
      - MAIN_HOST=demo-app
      - MAIN_PORT=3000
      - CHECK_INTERVAL_MS=200
      - MAX_WAIT_MS=90000
      - AUTO_STOP_WHEN_MAIN_UP=true
      - MAIN_STABLE_MS=5000
      - IDLE_BEFORE_STOP_MS=1500
    restart: "no"
